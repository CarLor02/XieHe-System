#!/bin/bash

################################################################################
# XieHe Medical System - 挖矿病毒清理脚本
# 
# 功能: 
#   1. 检测并停止所有受感染容器
#   2. 删除所有镜像强制重建
#   3. 清理恶意文件
#   4. 清理Docker缓存
#
# 使用方法:
#   chmod +x cleanup_malware.sh
#   ./cleanup_malware.sh
################################################################################

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}"
echo "╔════════════════════════════════════════════════════════════╗"
echo "║                                                            ║"
echo "║          XieHe Medical System - 病毒清理脚本               ║"
echo "║                                                            ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo -e "${NC}"
echo ""

echo -e "${YELLOW}⚠️  此脚本将:${NC}"
echo "  1. 停止前端容器"
echo "  2. 删除前端Docker镜像"
echo "  3. 清理Docker构建缓存"
echo "  4. 清理系统恶意文件"
echo ""

read -p "确认继续? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}❌ 操作已取消${NC}"
    exit 1
fi

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  步骤1: 检测挖矿进程${NC}"
echo -e "${CYAN}========================================${NC}"

# 检查所有容器的可疑进程
echo -e "${YELLOW}扫描运行中的容器...${NC}"
if docker ps -q 2>/dev/null | xargs -r docker exec -i {} ps aux 2>/dev/null | grep -i "javae\|xmrig\|c3pool\|/tmp/\.X" | grep -v grep; then
    echo -e "${RED}⚠️  发现可疑挖矿进程!${NC}"
else
    echo -e "${GREEN}✅ 未发现运行中的挖矿进程${NC}"
fi

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  步骤2: 停止前端容器${NC}"
echo -e "${CYAN}========================================${NC}"

# 只停止前端容器
docker stop medical_frontend 2>/dev/null || true
docker rm -f medical_frontend 2>/dev/null || true

echo -e "${GREEN}✅ 前端容器已停止并删除${NC}"

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  步骤3: 删除前端镜像${NC}"
echo -e "${CYAN}========================================${NC}"

# 删除前端相关镜像
docker images | grep -E "medical.*frontend|xiehe.*frontend|frontend.*medical" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true

# 删除构建时的中间镜像
docker images | grep "<none>" | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true

echo -e "${GREEN}✅ 前端镜像已删除${NC}"

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  步骤4: 清理系统恶意文件${NC}"
echo -e "${CYAN}========================================${NC}"

# 清理恶意目录
sudo rm -rf /tmp/.XIN-unix /tmp/.X11-unix 2>/dev/null || true
sudo rm -rf /var/tmp/.* 2>/dev/null || true
sudo rm -rf /dev/shm/* 2>/dev/null || true

# 清理Docker卷中的恶意文件
echo -e "${YELLOW}清理Docker卷...${NC}"
docker volume ls -q | while read vol; do
    docker run --rm -v "$vol:/vol" alpine sh -c "rm -rf /vol/.XIN-unix /vol/.*unix /vol/.X* 2>/dev/null || true" 2>/dev/null || true
done

echo -e "${GREEN}✅ 系统文件已清理${NC}"

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  步骤5: 清理Docker构建缓存${NC}"
echo -e "${CYAN}========================================${NC}"

# 只清理前端相关的构建缓存
docker builder prune -f

echo -e "${GREEN}✅ Docker构建缓存已清理${NC}"

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}  步骤6: 验证清理结果${NC}"
echo -e "${CYAN}========================================${NC}"

echo -e "${YELLOW}检查前端容器状态:${NC}"
docker ps -a | grep -E "CONTAINER|frontend" || echo "无前端容器"

echo ""
echo -e "${YELLOW}检查前端镜像:${NC}"
docker images | grep -E "REPOSITORY|frontend" || echo "无前端镜像"

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║                                                            ║${NC}"
echo -e "${GREEN}║                  前端清理完成!                             ║${NC}"
echo -e "${GREEN}║                                                            ║${NC}"
echo -e "${GREEN}║  下一步: 运行 ./deploy.sh 重新部署安全版本                ║${NC}"
echo -e "${GREEN}║          前端将使用nginx替代Node.js运行时                  ║${NC}"
echo -e "${GREEN}║                                                            ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"

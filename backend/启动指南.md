# FastAPI 应用启动指南

## ❌ 错误的启动方式

```bash
# 错误1: 直接运行 main.py
python backend/app/main.py
# 报错: ModuleNotFoundError: No module named 'app'

# 错误2: 在 app 目录下运行
cd backend/app
python main.py
# 报错: ModuleNotFoundError: No module named 'app'
```

**原因**: Python 无法找到 `app` 模块，因为当前工作目录不正确。

---

## ✅ 正确的启动方式

### 方式 1: 使用 uvicorn（推荐 - 开发环境）

```bash
# 1. 进入 backend 目录
cd backend

# 2. 激活 conda 环境
conda activate xiehe

# 3. 使用 uvicorn 启动
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**参数说明**:
- `app.main:app` - 模块路径:应用实例
- `--reload` - 代码修改后自动重启（仅开发环境）
- `--host 0.0.0.0` - 监听所有网络接口
- `--port 8000` - 端口号

---

### 方式 2: 使用 Python -m 运行

```bash
# 1. 进入 backend 目录
cd backend

# 2. 激活 conda 环境
conda activate xiehe

# 3. 使用 -m 参数运行
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

### 方式 3: 修改 main.py 的启动代码（不推荐）

如果一定要直接运行 `python app/main.py`，需要修改 `main.py` 文件：

```python
# 在 main.py 文件开头添加
import sys
from pathlib import Path

# 将 backend 目录添加到 Python 路径
backend_dir = Path(__file__).parent.parent
sys.path.insert(0, str(backend_dir))
```

但这种方式**不推荐**，因为会导致路径混乱。

---

### 方式 4: 使用 gunicorn（生产环境）

```bash
# 1. 进入 backend 目录
cd backend

# 2. 激活 conda 环境
conda activate xiehe

# 3. 使用 gunicorn 启动
gunicorn app.main:app -c gunicorn.conf.py
```

---

## 🚀 完整启动流程（推荐）

### 步骤 1: 打开终端

在 VSCode 中打开终端（Ctrl + `）或使用 PowerShell

### 步骤 2: 导航到项目目录

```powershell
cd D:\work\星纬算法\协和医院\代码\XieHe-System
```

### 步骤 3: 进入 backend 目录

```powershell
cd backend
```

### 步骤 4: 激活 conda 环境

```powershell
conda activate xiehe
```

### 步骤 5: 启动应用

```powershell
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 步骤 6: 验证启动成功

看到以下输出表示启动成功：

```
INFO:     Will watch for changes in these directories: ['D:\\work\\星纬算法\\协和医院\\代码\\XieHe-System\\backend']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [xxxxx] using WatchFiles
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### 步骤 7: 访问应用

在浏览器中访问：
- API 文档: http://localhost:8000/api/v1/docs
- 健康检查: http://localhost:8000/health
- 根路径: http://localhost:8000/

---

## 🔧 一键启动脚本

为了方便启动，可以创建启动脚本：

### Windows PowerShell 脚本

创建 `backend/start.ps1`:

```powershell
# 启动 FastAPI 应用
Write-Host "🚀 启动 XieHe 医疗影像诊断系统..." -ForegroundColor Green

# 检查是否在 backend 目录
if (-not (Test-Path "app/main.py")) {
    Write-Host "❌ 错误: 请在 backend 目录下运行此脚本" -ForegroundColor Red
    exit 1
}

# 激活 conda 环境
Write-Host "📦 激活 conda 环境: xiehe" -ForegroundColor Yellow
conda activate xiehe

# 启动应用
Write-Host "🌐 启动应用在 http://localhost:8000" -ForegroundColor Cyan
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

使用方式：
```powershell
cd backend
.\start.ps1
```

### Linux/Mac Bash 脚本

创建 `backend/start.sh`:

```bash
#!/bin/bash

# 启动 FastAPI 应用
echo "🚀 启动 XieHe 医疗影像诊断系统..."

# 检查是否在 backend 目录
if [ ! -f "app/main.py" ]; then
    echo "❌ 错误: 请在 backend 目录下运行此脚本"
    exit 1
fi

# 激活 conda 环境
echo "📦 激活 conda 环境: xiehe"
source ~/miniconda3/etc/profile.d/conda.sh
conda activate xiehe

# 启动应用
echo "🌐 启动应用在 http://localhost:8000"
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

使用方式：
```bash
cd backend
chmod +x start.sh
./start.sh
```

---

## 🐛 常见问题排查

### 问题 1: ModuleNotFoundError: No module named 'app'

**原因**: 当前工作目录不正确

**解决**:
```bash
# 确保在 backend 目录下
cd backend
pwd  # 或 Windows 下用 cd（查看当前目录）

# 然后启动
uvicorn app.main:app --reload
```

### 问题 2: ModuleNotFoundError: No module named 'uvicorn'

**原因**: uvicorn 未安装

**解决**:
```bash
conda activate xiehe
pip install uvicorn
```

### 问题 3: 端口 8000 已被占用

**原因**: 端口被其他进程占用（可能是之前的 start_demo.py）

**解决**:
```powershell
# 查找占用端口的进程
netstat -ano | findstr "8000"

# 杀死进程（替换 PID 为实际进程 ID）
taskkill /PID <PID> /F

# 或者使用其他端口
uvicorn app.main:app --reload --port 8001
```

### 问题 4: 数据库连接失败

**原因**: 数据库配置不正确或数据库未启动

**解决**:
```bash
# 检查 .env 文件中的数据库配置
cat .env

# 或创建 .env 文件
# 在 backend 目录下创建 .env 文件，内容如下：
```

创建 `backend/.env`:
```env
# 数据库配置
DB_HOST=115.190.121.59
DB_PORT=3306
DB_USER=root
DB_PASSWORD=qweasd2025
DB_NAME=medical_imaging_system

# 应用配置
ENVIRONMENT=development
DEBUG=true
SECRET_KEY=your-secret-key-here

# API 配置
API_V1_STR=/api/v1
```

---

## 📝 总结

**最简单的启动方式**:

```bash
# 1. 打开终端
# 2. 执行以下命令
cd D:\work\星纬算法\协和医院\代码\XieHe-System\backend
conda activate xiehe
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**关键点**:
- ✅ 必须在 `backend` 目录下运行
- ✅ 使用 `uvicorn app.main:app` 而不是 `python app/main.py`
- ✅ 激活正确的 conda 环境 `xiehe`
- ✅ 确保数据库配置正确


# æµ‹è¯•å·¥å…·é›†

æœ¬ç›®å½•åŒ…å«é¡¹ç›®çš„æ‰€æœ‰æµ‹è¯•å·¥å…·ï¼ŒåŒ…æ‹¬è‡ªåŠ¨åŒ–æµ‹è¯•å’Œæ‰‹åŠ¨æµ‹è¯•å·¥å…·ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ __init__.py                 # æµ‹è¯•åŒ…åˆå§‹åŒ–
â”œâ”€â”€ README.md                   # æœ¬æ–‡æ¡£
â”œâ”€â”€ pytest.ini                  # pytesté…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
â”‚
â”œâ”€â”€ unit/                       # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ ...                     # å„æ¨¡å—çš„å•å…ƒæµ‹è¯•
â”‚
â”œâ”€â”€ integration/                # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ ...                     # é›†æˆæµ‹è¯•ç”¨ä¾‹
â”‚
â”œâ”€â”€ fixtures/                   # æµ‹è¯•å¤¹å…·
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ ...                     # å…±äº«çš„æµ‹è¯•æ•°æ®å’Œå¤¹å…·
â”‚
â”œâ”€â”€ manual/                     # æ‰‹åŠ¨æµ‹è¯•å·¥å…· â­ æ–°å¢
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_auth_manual.py    # è®¤è¯åŠŸèƒ½æ‰‹åŠ¨æµ‹è¯•
â”‚
â”œâ”€â”€ db_tools/                   # æ•°æ®åº“å·¥å…· â­ æ–°å¢
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ check_users.py         # æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
â”‚   â””â”€â”€ check_table_structure.py # æŸ¥çœ‹è¡¨ç»“æ„
â”‚
â””â”€â”€ test_*.py                   # è‡ªåŠ¨åŒ–æµ‹è¯•æ–‡ä»¶
    â”œâ”€â”€ test_auth.py            # è®¤è¯æµ‹è¯•
    â”œâ”€â”€ test_dashboard.py       # ä»ªè¡¨ç›˜æµ‹è¯•
    â”œâ”€â”€ test_reports.py         # æŠ¥å‘Šæµ‹è¯•
    â””â”€â”€ ...
```

## ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd backend
pytest
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
pytest tests/test_auth.py
pytest tests/test_dashboard.py
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»æˆ–æ–¹æ³•

```bash
pytest tests/test_auth.py::TestAuthAPI
pytest tests/test_auth.py::TestAuthAPI::test_login_success
```

### æ˜¾ç¤ºè¯¦ç»†è¾“å‡º

```bash
pytest -v
pytest -vv
```

### æ˜¾ç¤ºæ‰“å°è¾“å‡º

```bash
pytest -s
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
pytest --cov=app --cov-report=html
```

## ğŸ”§ æ‰‹åŠ¨æµ‹è¯•å·¥å…·

æ‰‹åŠ¨æµ‹è¯•å·¥å…·ä½äº `tests/manual/` ç›®å½•ï¼Œéœ€è¦åç«¯æœåŠ¡è¿è¡Œã€‚

### è®¤è¯åŠŸèƒ½æµ‹è¯•

```bash
cd backend

# è¿è¡Œæ‰€æœ‰è®¤è¯æµ‹è¯•
python tests/manual/test_auth_manual.py

# åªæµ‹è¯•ç™»å½•
python tests/manual/test_auth_manual.py login

# åªæµ‹è¯•æ³¨å†Œ
python tests/manual/test_auth_manual.py register

# æµ‹è¯•å®Œæ•´æµç¨‹ï¼ˆæ³¨å†Œ+ç™»å½•ï¼‰
python tests/manual/test_auth_manual.py full
```

**åŠŸèƒ½**:
- âœ… æµ‹è¯•å¤šä¸ªè´¦å·ç™»å½•ï¼ˆadmin, doctor01ç­‰ï¼‰
- âœ… æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
- âœ… æµ‹è¯•å®Œæ•´çš„æ³¨å†Œ+ç™»å½•æµç¨‹
- âœ… å½©è‰²è¾“å‡ºï¼Œæ˜“äºé˜…è¯»
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

## ğŸ—„ï¸ æ•°æ®åº“å·¥å…·

æ•°æ®åº“å·¥å…·ä½äº `tests/db_tools/` ç›®å½•ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹å’Œç®¡ç†æ•°æ®åº“ã€‚

### æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨

```bash
cd backend
python tests/db_tools/check_users.py
```

**è¾“å‡ºç¤ºä¾‹**:
```
ID    ç”¨æˆ·å          é‚®ç®±                           å§“å            çŠ¶æ€        è§’è‰²        åˆ›å»ºæ—¶é—´
---------------------------------------------------------------------------------------------------
1     admin          admin@xiehe.com                ç³»ç»Ÿç®¡ç†å‘˜       active âœ“    admin      2025-10-14 10:00:00
2     doctor01       doctor01@xiehe.com             å¼ åŒ»ç”Ÿ          active âœ“    doctor     2025-10-14 10:05:00

ç»Ÿè®¡ä¿¡æ¯:
æ€»ç”¨æˆ·æ•°: 10
æ¿€æ´»ç”¨æˆ·: 8
ç®¡ç†å‘˜æ•°: 2
å·²éªŒè¯ç”¨æˆ·: 9
```

### æŸ¥çœ‹è¡¨ç»“æ„

```bash
cd backend

# æŸ¥çœ‹ users è¡¨ï¼ˆé»˜è®¤ï¼‰
python tests/db_tools/check_table_structure.py

# æŸ¥çœ‹æŒ‡å®šè¡¨
python tests/db_tools/check_table_structure.py patients
python tests/db_tools/check_table_structure.py studies

# åˆ—å‡ºæ‰€æœ‰è¡¨
python tests/db_tools/check_table_structure.py --list
```

**è¾“å‡ºç¤ºä¾‹**:
```
å­—æ®µå                    ç±»å‹                      å…è®¸NULL   é”®         é»˜è®¤å€¼          é¢å¤–
-------------------------------------------------------------------------------------------------------------------------
id                       int                       NO        PRI                       auto_increment
username                 varchar(50)               NO        UNI
email                    varchar(100)              NO        UNI
real_name                varchar(50)               YES                   NULL
password_hash            varchar(255)              NO
...

è®°å½•æ€»æ•°: 10

ç´¢å¼•ä¿¡æ¯:
  PRIMARY: PRIMARY (id)
  UNIQUE: username (username)
  UNIQUE: email (email)
```

### é‡å»ºæ•°æ®åº“ â­ æ–°å¢

```bash
cd backend

# äº¤äº’å¼é‡å»ºï¼ˆéœ€è¦ç¡®è®¤ï¼‰
python tests/db_tools/recreate_database.py

# å¼ºåˆ¶é‡å»ºï¼ˆè·³è¿‡ç¡®è®¤ï¼Œå±é™©ï¼ï¼‰
python tests/db_tools/recreate_database.py --force
```

**åŠŸèƒ½**:
- âœ… åˆ é™¤æ‰€æœ‰ç°æœ‰è¡¨
- âœ… åˆ›å»ºæ–°è¡¨ç»“æ„
- âœ… æ’å…¥åˆå§‹æ•°æ®ï¼ˆç®¡ç†å‘˜ã€è§’è‰²ã€æƒé™ã€éƒ¨é—¨ï¼‰
- âœ… éªŒè¯åˆ›å»ºç»“æœ

**é»˜è®¤è´¦å·**:
- ç”¨æˆ·å: admin
- å¯†ç : admin123
- é‚®ç®±: admin@xiehe.com

## ğŸ“Š æµ‹è¯•æ–‡ä»¶è¯´æ˜

### è‡ªåŠ¨åŒ–æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | æµ‹è¯•å†…å®¹ |
|------|------|---------|
| `test_auth.py` | è®¤è¯æµ‹è¯• | ç™»å½•ã€æ³¨å†Œã€ä»¤ç‰Œã€æƒé™ |
| `test_dashboard.py` | ä»ªè¡¨ç›˜æµ‹è¯• | æ•°æ®ç»Ÿè®¡ã€å›¾è¡¨ |
| `test_reports.py` | æŠ¥å‘Šæµ‹è¯• | æŠ¥å‘Šç”Ÿæˆã€æŸ¥è¯¢ã€æ›´æ–° |
| `test_ai_models.py` | AIæ¨¡å‹æµ‹è¯• | æ¨¡å‹æ¨ç†ã€ç»“æœå¤„ç† |
| `test_image_display.py` | å½±åƒæ˜¾ç¤ºæµ‹è¯• | å½±åƒåŠ è½½ã€æ¸²æŸ“ |
| `test_monitoring.py` | ç›‘æ§æµ‹è¯• | ç³»ç»Ÿç›‘æ§ã€å‘Šè­¦ |
| `test_notifications.py` | é€šçŸ¥æµ‹è¯• | æ¶ˆæ¯æ¨é€ã€é€šçŸ¥ |
| `test_permissions.py` | æƒé™æµ‹è¯• | æƒé™éªŒè¯ã€è§’è‰² |
| `test_unit.py` | å•å…ƒæµ‹è¯• | åŸºç¡€åŠŸèƒ½å•å…ƒæµ‹è¯• |

### æ‰‹åŠ¨æµ‹è¯•å·¥å…·

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `manual/test_auth_manual.py` | è®¤è¯æ‰‹åŠ¨æµ‹è¯• | å¿«é€ŸéªŒè¯ç™»å½•ã€æ³¨å†ŒåŠŸèƒ½ |

### æ•°æ®åº“å·¥å…·

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `db_tools/check_users.py` | ç”¨æˆ·æ£€æŸ¥å·¥å…· | æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨å’Œç»Ÿè®¡ |
| `db_tools/check_table_structure.py` | è¡¨ç»“æ„æ£€æŸ¥å·¥å…· | æŸ¥çœ‹è¡¨ç»“æ„å’Œæ•°æ® |
| `db_tools/recreate_database.py` | æ•°æ®åº“é‡å»ºå·¥å…· â­ | é‡å»ºæ•°æ®åº“å’Œåˆå§‹æ•°æ® |

### æµ‹è¯•æ•°æ®å¤¹å…· â­ æ–°å¢

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `fixtures/patient_data.py` | æµ‹è¯•æ‚£è€…æ•°æ® | æä¾›æµ‹è¯•ç”¨æ‚£è€…å’Œæ£€æŸ¥æ•°æ® |

## ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•

- âœ… ä½¿ç”¨ pytest æ¡†æ¶
- âœ… éµå¾ª AAA æ¨¡å¼ï¼ˆArrange, Act, Assertï¼‰
- âœ… ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•åç§°
- âœ… æ¯ä¸ªæµ‹è¯•åªæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½ç‚¹
- âœ… ä½¿ç”¨ fixtures å…±äº«æµ‹è¯•æ•°æ®
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 80%

### 2. æ‰‹åŠ¨æµ‹è¯•

- âœ… ç”¨äºå¿«é€ŸéªŒè¯åŠŸèƒ½
- âœ… ä¸æ›¿ä»£è‡ªåŠ¨åŒ–æµ‹è¯•
- âœ… é€‚åˆå¼€å‘è°ƒè¯•é˜¶æ®µ
- âœ… éœ€è¦åç«¯æœåŠ¡è¿è¡Œ

### 3. æ•°æ®åº“å·¥å…·

- âœ… åªè¯»æ“ä½œï¼Œä¸ä¿®æ”¹æ•°æ®
- âœ… ç”¨äºå¿«é€Ÿæ£€æŸ¥æ•°æ®çŠ¶æ€
- âœ… å¼€å‘å’Œè°ƒè¯•æ—¶ä½¿ç”¨

## ğŸ”„ ä» dev_tools è¿ç§»

åŸ `dev_tools/` ç›®å½•å·²æ•´åˆåˆ° `tests/` ç›®å½•ï¼š

| åŸæ–‡ä»¶ | æ–°ä½ç½® | è¯´æ˜ |
|--------|--------|------|
| `dev_tools/test_login.py` | `tests/manual/test_auth_manual.py` | æ•´åˆä¸ºæ‰‹åŠ¨æµ‹è¯•å·¥å…· |
| `dev_tools/test_register.py` | `tests/manual/test_auth_manual.py` | æ•´åˆä¸ºæ‰‹åŠ¨æµ‹è¯•å·¥å…· |
| `dev_tools/test_full_register_login.py` | `tests/manual/test_auth_manual.py` | æ•´åˆä¸ºæ‰‹åŠ¨æµ‹è¯•å·¥å…· |
| `dev_tools/check_users.py` | `tests/db_tools/check_users.py` | æ”¹è¿›å¹¶ç§»åŠ¨ |
| `dev_tools/check_table_structure.py` | `tests/db_tools/check_table_structure.py` | æ”¹è¿›å¹¶ç§»åŠ¨ |

**æ”¹è¿›ç‚¹**:
- âœ… æ›´å¥½çš„ä»£ç ç»„ç»‡
- âœ… ç»Ÿä¸€çš„å‘½ä»¤è¡Œæ¥å£
- âœ… å½©è‰²è¾“å‡º
- âœ… æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
- âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶è€Œéç¡¬ç¼–ç 

## ğŸ“ æ·»åŠ æ–°æµ‹è¯•

### æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•

1. åœ¨ `tests/` ç›®å½•åˆ›å»º `test_*.py` æ–‡ä»¶
2. ä½¿ç”¨ pytest ç¼–å†™æµ‹è¯•ç”¨ä¾‹
3. è¿è¡Œ `pytest` éªŒè¯

ç¤ºä¾‹:
```python
# tests/test_example.py
import pytest

class TestExample:
    def test_something(self):
        assert 1 + 1 == 2
```

### æ·»åŠ æ‰‹åŠ¨æµ‹è¯•å·¥å…·

1. åœ¨ `tests/manual/` ç›®å½•åˆ›å»ºè„šæœ¬
2. æ·»åŠ å‘½ä»¤è¡Œæ¥å£
3. æ›´æ–°æœ¬ README

### æ·»åŠ æ•°æ®åº“å·¥å…·

1. åœ¨ `tests/db_tools/` ç›®å½•åˆ›å»ºè„šæœ¬
2. ä½¿ç”¨ settings è·å–æ•°æ®åº“é…ç½®
3. åªè¿›è¡Œåªè¯»æ“ä½œ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¼€å‘è€…ç¬¬ä¸€æ¬¡ä½¿ç”¨

```bash
# 1. å®‰è£…ä¾èµ–
cd backend
pip install -r requirements.txt

# 2. è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
pytest

# 3. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰
uvicorn app.main:app --reload

# 4. è¿è¡Œæ‰‹åŠ¨æµ‹è¯•
python tests/manual/test_auth_manual.py

# 5. æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
python tests/db_tools/check_users.py
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `backend/README.md` - åç«¯é¡¹ç›®è¯´æ˜
- `backend/å¯åŠ¨æŒ‡å—.md` - å¯åŠ¨æŒ‡å—
- `pytest.ini` - pytest é…ç½®
- `conftest.py` - pytest å…¨å±€é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰

---

**æ›´æ–°æ—¶é—´**: 2025-10-14  
**ç»´æŠ¤è€…**: XieHe Medical System Team

